name: üöÄ Laravel + Vite Auto Deploy (Warehouse)

on:
  push:
    branches:
      - main
      - staging

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    env:
      PROJECT_NAME: "Warehouse Management"
      DEPLOY_PATH_PROD: "/www/wwwroot/warehouse.fahd.my.id"
      DEPLOY_PATH_STAGING: "/www/wwwroot/staging.warehouse.fahd.my.id"
      BACKUP_PATH: "/www/wwwroot/backups"

    steps:
      # 1Ô∏è Checkout kode dari GitHub
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è Setup Node.js (untuk Vite build)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # 3Ô∏è Install & Build Frontend (Vite)
      - name: Build Frontend (Vite)
        run: |
          echo "VITE_PUSHER_APP_KEY=${{ secrets.PUSHER_APP_KEY }}" >> .env
          echo "VITE_PUSHER_APP_CLUSTER=${{ secrets.PUSHER_APP_CLUSTER }}" >> .env
          echo "VITE_PUSHER_APP_FORCE_TLS=true" >> .env

          # Hapus build lama supaya tidak bentrok cache
          rm -rf public/build

          npm ci
          npm run build


      # 4Ô∏è Setup PHP (Laravel)
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.3
          extensions: mbstring, bcmath, intl, zip, gd, pdo_mysql
          coverage: none

      # 5Ô∏è Install Composer dependencies
      - name: Install Composer dependencies
        run: composer install --no-dev --optimize-autoloader --no-interaction --prefer-dist

      # 6Ô∏è Tentukan target environment berdasarkan branch
      - name: Set environment path
        id: set-env
        run: |
          if [[ "${GITHUB_REF_NAME}" == "main" ]]; then
            echo "target_path=${{ env.DEPLOY_PATH_PROD }}" >> $GITHUB_OUTPUT
            echo "env_label=warehouse.fahd.my.id" >> $GITHUB_OUTPUT
          else
            echo "target_path=${{ env.DEPLOY_PATH_STAGING }}" >> $GITHUB_OUTPUT
            echo "env_label=warehouse.fahd.my.id" >> $GITHUB_OUTPUT
          fi
          echo "commit_message=$(git log -1 --pretty=%B)" >> $GITHUB_OUTPUT

      # 7Ô∏è Telegram Notification (Start)
      - name: Telegram Notification (Start)
        run: |
          MSG=$(cat <<EOF
          üöÄ <b>Deploy Dimulai!</b>
          üåê Website: <a href="https://${{ steps.set-env.outputs.env_label }}">${{ steps.set-env.outputs.env_label }}</a>
          üïí $(TZ='Asia/Jakarta' date '+%d %b %Y, %H:%M:%S') WIB
          üë§ Oleh: <b>${{ github.actor }}</b>
          üíª Repository: <code>${{ github.repository }}</code>
          üß© Branch: <b>${{ github.ref_name }}</b>
          ‚è≥ Mohon tunggu...
          EOF
          )
          for CHAT_ID in ${{ secrets.TELEGRAM_CHAT_IDS }}; do
            curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
              -d chat_id=$CHAT_ID \
              -d parse_mode="HTML" \
              -d text="$MSG"
          done

      # 8Ô∏è Disable host key checking biar SSH gak error
      - name: Disable host key checking
        run: |
          mkdir -p ~/.ssh
          echo "StrictHostKeyChecking no" >> ~/.ssh/config
          echo "UserKnownHostsFile=/dev/null" >> ~/.ssh/config

      # 9Ô∏è Backup versi sebelumnya sebelum upload
      - name: Backup existing deployment
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ubuntu
          key: ${{ secrets.SERVER_SSH_KEY }}
          use_insecure_cipher: true
          script: |
            sudo -u www mkdir -p /www/wwwroot/backups
            cd /www/wwwroot/warehouse.fahd.my.id || exit 0
            sudo -u www tar -czf /www/wwwroot/backups/warehouse_backup_$(date +'%Y%m%d_%H%M%S').tar.gz . || echo "Backup skipped"

      # 10Ô∏è Upload file ke server via SCP (to temp folder)
      - name: Upload Files via SCP (to temp folder)
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          source: "./"
          target: "/tmp/warehouse_tmp"
          strip_components: 0
          overwrite: true
          use_insecure_cipher: true
          exclude: |
            .env
            node_modules/
            storage/
            tests/
            deploy.log
            .git/
            .github/

      # 11Ô∏è Pindahkan dari temp ke folder sebenarnya
      - name: Move uploaded files to webroot
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            echo "Moving files from /tmp/warehouse_tmp to ${{ steps.set-env.outputs.target_path }} ..."
            sudo rsync -a --delete --exclude=".env" /tmp/warehouse_tmp/ ${{ steps.set-env.outputs.target_path }}/
            sudo rm -rf /tmp/warehouse_tmp
            echo "Files moved successfully (env preserved)!"

      # 12Ô∏è Jalankan artisan commands di server
      - name: Run Laravel Commands
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          use_insecure_cipher: true
          script: |
            cd ${{ steps.set-env.outputs.target_path }}
            php artisan down || true
            php artisan migrate:fresh --seed --force
            php artisan optimize:clear
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
            php artisan up

      # 13Ô∏è Fix File Permissions
      - name: Fix File Permissions
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          use_insecure_cipher: true
          script: |
            echo "Fixing ownership and permissions..."
            sudo chown -R www:www ${{ steps.set-env.outputs.target_path }} || true
            sudo find ${{ steps.set-env.outputs.target_path }} -type f -exec chmod 644 {} \; || true
            sudo find ${{ steps.set-env.outputs.target_path }} -type d -exec chmod 755 {} \; || true
            sudo chmod -R 775 ${{ steps.set-env.outputs.target_path }}/storage || true
            sudo chmod -R 775 ${{ steps.set-env.outputs.target_path }}/bootstrap/cache || true
            echo "Permissions fixed!"

      # 14Ô∏è Telegram Notification (Success)
      - name: Telegram Notification (Success)
        if: success()
        run: |
          MSG=$(cat <<EOF
          ‚úÖ <b>Deploy Berhasil!</b>
          üåê Website: <a href="https://${{ steps.set-env.outputs.env_label }}">${{ steps.set-env.outputs.env_label }}</a>
          üïí $(TZ='Asia/Jakarta' date '+%d %b %Y, %H:%M:%S') WIB
          üë§ Commit by: <b>${{ github.actor }}</b>
          üß© Branch: <b>${{ github.ref_name }}</b>
          üíª Repository: <code>${{ github.repository }}</code>
          üéâ Berhasil di-deploy tanpa error!
          üí¨ Pesan Commit: <i>${{ steps.set-env.outputs.commit_message }}</i>
          EOF
          )
          for CHAT_ID in ${{ secrets.TELEGRAM_CHAT_IDS }}; do
            curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
              -d chat_id=$CHAT_ID \
              -d parse_mode="HTML" \
              -d text="$MSG"
          done

      # 15Ô∏è Rollback otomatis jika gagal
      - name: Rollback if failed
        if: failure()
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          use_insecure_cipher: true
          script: |
            cd ${{ env.BACKUP_PATH }}
            LATEST_BACKUP=$(ls -t warehouse_backup_*.tar.gz | head -n 1)
            if [ -n "$LATEST_BACKUP" ]; then
              echo "Rolling back from backup: $LATEST_BACKUP"
              tar -xzf $LATEST_BACKUP -C ${{ steps.set-env.outputs.target_path }}
            fi

      # 16Ô∏è Telegram Notification (Failed)
      - name: Telegram Notification (Failed)
        if: failure()
        run: |
          MSG=$(cat <<EOF
          ‚ùå <b>Deploy Gagal!</b>
          üåê Website: <a href="https://${{ steps.set-env.outputs.env_label }}">${{ steps.set-env.outputs.env_label }}</a>
          üïí $(TZ='Asia/Jakarta' date '+%d %b %Y, %H:%M:%S') WIB
          üë§ Commit by: <b>${{ github.actor }}</b>
          üß© Branch: <b>${{ github.ref_name }}</b>
          üíª Repository: <code>${{ github.repository }}</code>
          ‚öôÔ∏è Deploy otomatis akan rollback ke versi terakhir.
          üîç Cek log GitHub Actions untuk detail error.
          üí¨ Pesan Commit: <i>${{ steps.set-env.outputs.commit_message }}</i>
          EOF
          )
          for CHAT_ID in ${{ secrets.TELEGRAM_CHAT_IDS }}; do
            curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
              -d chat_id=$CHAT_ID \
              -d parse_mode="HTML" \
              -d text="$MSG"
          done
