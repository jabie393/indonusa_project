<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dynamic PIC - Tambah & Hapus</title>

    <!-- JQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Select2 -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <style>
        body { font-family: Arial; padding: 20px; }
        .pic-box {
            width: 450px;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        .label-title { font-size: 16px; font-weight: bold; margin-bottom: 10px; }
        .remove-btn {
            background: #c62828; color: white; border: none;
            padding: 5px 12px; border-radius: 5px; cursor: pointer;
        }
        .add-btn {
            background: #2e7d32; color: white; border: none;
            padding: 8px 15px; border-radius: 6px; cursor: pointer;
        }
        .select2-container--default .select2-selection--single {
            height: 38px; padding-top: 4px; border-radius: 6px; border: 1px solid #ced4da;
        }
        .select2-container--default .select2-selection__arrow { top: 6px; }
        .hidden { display: none; }
    </style>
</head>
<body>

<h2>Dynamic PIC Customer (Tambah & Hapus)</h2>

<div id="picList"></div>

<br>
<button class="add-btn" id="btnTambahPIC">+ Tambah PIC</button>

<br><br>
<button id="submitBtn">Submit</button>

<p id="result"></p>

<script>
    let picIndex = 0;

    // --- MOCK DATA (simulate DB) ---
    function mockSearch(keyword) {
        const samplePIC = [
            { id: 1, nama: "Manager - Budi Santoso" },
            { id: 2, nama: "Supervisor - Rani Wika" },
            { id: 3, nama: "Staff - Dewi Rahma" }
        ];

        return samplePIC.filter(i =>
            i.nama.toLowerCase().includes(keyword.toLowerCase())
        );
    }

    // --- ADD NEW PIC BLOCK ---
    function addPIC() {
        picIndex++;

        let html = `
        <div class="pic-box" data-index="${picIndex}">
            <div class="label-title">PIC ${picIndex}</div>

            <!-- Radio Options -->
            <label>
                <input type="radio" name="picMode_${picIndex}" value="db" checked>
                Pilih PIC dari database
            </label><br>

            <label>
                <input type="radio" name="picMode_${picIndex}" value="manual">
                Input PIC baru (ketik manual)
            </label>

            <br><br>

            <!-- Select PIC -->
            <div class="pic-select-wrapper">
                <label>PIC dari database</label>
                <select class="picSelect" style="width:100%;"></select>
            </div>

            <!-- Input manual -->
            <div class="pic-manual-wrapper hidden">
                <label>Nama PIC Baru</label>
                <input type="text" class="picManualInput"
                    style="width:100%;height:38px;border:1px solid #ced4da;border-radius:6px;padding-left:8px;">
            </div>

            <br>

            <button class="remove-btn btnRemove">Hapus PIC</button>
        </div>
        `;

        $("#picList").append(html);

        initSelect2();
    }

    // --- INIT SELECT2 ---
    function initSelect2() {
        $(".picSelect").select2({
            placeholder: "Cari PIC dari database...",
            allowClear: true,
            minimumInputLength: 1,

            ajax: {
                transport: function (params, success) {
                    setTimeout(() => {
                        success(mockSearch(params.data.q));
                    }, 250);
                },
                processResults: function (data) {
                    return {
                        results: data.map(i => ({
                            id: i.id,
                            text: i.nama
                        }))
                    };
                }
            }
        });
    }

    // --- TOMBOL TAMBAH ---
    $("#btnTambahPIC").on("click", function () {
        addPIC();
    });

    // --- SWITCH RADIO PIC MODE ---
    $(document).on("change", "input[type=radio]", function () {
        let box = $(this).closest(".pic-box");
        let mode = $(this).val();

        if (mode === "db") {
            box.find(".pic-select-wrapper").show();
            box.find(".pic-manual-wrapper").hide();
        } else {
            box.find(".pic-select-wrapper").hide();
            box.find(".pic-manual-wrapper").show();
        }
    });

    // --- HAPUS PIC ---
    $(document).on("click", ".btnRemove", function () {
        $(this).closest(".pic-box").remove();
        renumberPIC();
    });

    // --- RENUMBER AFTER DELETE ---
    function renumberPIC() {
        let i = 1;
        $("#picList .pic-box").each(function () {
            $(this).attr("data-index", i);
            $(this).find(".label-title").text("PIC " + i);
            i++;
        });
        picIndex = $("#picList .pic-box").length;
    }

    // --- SUBMIT TEST ---
    $("#submitBtn").click(function () {
        let results = [];

        $("#picList .pic-box").each(function () {
            let index = $(this).data("index");
            let mode = $(`input[name="picMode_${index}"]:checked`).val();

            if (mode === "db") {
                results.push({
                    pic_no: index,
                    mode: "database",
                    value: $(this).find(".picSelect").val()
                });
            } else {
                results.push({
                    pic_no: index,
                    mode: "manual",
                    value: $(this).find(".picManualInput").val()
                });
            }
        });

        $("#result").html("<pre>" + JSON.stringify(results, null, 2) + "</pre>");
    });

    // Tambahkan 1 PIC default
    addPIC();

</script>

</body>
</html>
